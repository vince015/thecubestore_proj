{% extends "system_app/base.html" %}

{% load mathfilters %}
{% load staticfiles %}
{% block pagetitle %}Dashboard{% endblock %}

{% block breadcrumb %}
<h1>
    Dashboard
</h1>
<ol class="breadcrumb">
    <li class="active"><i class="fa fa-dashboard"></i> Dashboard</a></li>
</ol>
{% endblock %}

{% block main %}
    <div class="row">
        <section class="col-lg-12 connectedSortable">
            <div class="nav-tabs-custom">
                <ul class="nav nav-tabs">
                    <li class="active"><a href="#items" data-toggle="tab">Items</a></li>
                    <li><a href="#sales" data-toggle="tab">Sales</a></li>
                    <li><a href="#merchants" data-toggle="tab">Merchants</a></li>
                    <li><a href="#payouts" data-toggle="tab">Payouts</a></li>
                </ul>
                <div class="tab-content">
                    <div class="active tab-pane" id="items">
                        <table id="item_table" class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Desciption</th>
                                    <th>Stock</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Discount</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in items %}
                                    <tr>
                                        <form action="{% url 'sales_add' %}" method="post">
                                        {% csrf_token %}
                                        <td>
                                            <a href="{% url 'item_detail' item_id=item.id %}">
                                                {{ item.code }}
                                            </a>
                                            <input type="hidden" name="item" value="{{ item.id }}">
                                            <input type="hidden" name="code" value="{{ item.code }}">
                                        </td>
                                        <td>
                                            {{ item.description }}
                                        </td>
                                        <td>
                                            <!-- number of items in the inventory -->
                                            {{ item.quantity }}
                                        </td>
                                        <td>
                                            {{ item.price }}
                                            <input type="hidden" name="price" value="{{ item.price }}">
                                        </td>
                                        <td>
                                            <!-- purchase quantity -->
                                            <input type="number"
                                                   name="quantity"
                                                   id="quantityInput"
                                                   max="{{ item.quantity }}"
                                                   min="1"
                                                   value="1"
                                                   required="true"
                                                   class="form-control pull-right"
                                                   placeholder="Quantity of item deposited in cube"
                                                   style="width: 65px">
                                        </td>
                                        <td>
                                            <input type="number"
                                                   name="discount"
                                                   id="discountInput"
                                                   max="100"
                                                   min="0"
                                                   value="0"
                                                   required="true"
                                                   class="form-control pull-right"
                                                   placeholder="Discount"
                                                   style="width: 65px">
                                        </td>
                                        <td>
                                            {% if item.quantity > 0%}
                                            <button type="submit" class="btn btn-info btn-flat pull-right buy_btn">
                                            {% else %}
                                            <button type="submit" disabled class="btn btn-info btn-flat pull-right buy_btn disabled">
                                            {% endif %}
                                                <i class="fa fa-shopping-basket"></i>
                                            </button>
                                        </td>
                                    </form>
                                    </tr>
                                {% endfor%}
                            </tbody>
                        </table>
                    </div>
                    <div class="tab-pane" id="sales">
                        <div class="col-lg-12 col-xs-12">
                            <!-- small box -->
                            <div class="small-box bg-blue">
                                <div class="inner">
                                    <h3>{{ unpaid }}<sup style="font-size: 20px">Php</sup></h3>

                                    <p>Unpaid Sales</p>
                                </div>
                                <div class="icon">
                                    <i class="ion ion-stats-bars"></i>
                                </div>
                            </div>
                        </div>

                        <table id="sales_table" class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Date</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Gross</th>
                                    <th>Net</th>
                                    <th>Payout</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sale in sales %}
                                    <tr>
                                        <td>
                                            {{ sale.item }}
                                        </td>
                                        <td>
                                            {{ sale.date|date:'Y-m-d' }}
                                        </td>
                                        <td>
                                            {{ sale.quantity }}
                                        </td>
                                        <td>
                                            {{ sale.gross|div:sale.quantity }}
                                        </td>
                                        <td>
                                            {{ sale.gross }}
                                        </td>
                                        <td>
                                            {{ sale.net }}
                                        </td>
                                        <td>
                                            {% if sale.payout %}
                                                <a href="{% url 'payout_detail' payout_id=sale.payout %}">
                                                    {{ sale.payout }}
                                                </a>
                                            {% else %}
                                                <i>Unpaid</i>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor%}
                            </tbody>
                        </table>
                    </div>
                    <div class="tab-pane" id="merchants">
                        <table id="merchants_table" class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Contact Number</th>
                                    <th>Next Due Date</th>
                                    <th>Cube</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for merchant in merchants %}
                                    <tr>
                                        <td>
                                            <a href="{% url 'merchant_detail' user_id=merchant.profile.id %}">
                                                {{ merchant.profile.merchant_id }}
                                            </a>
                                        </td>
                                        <td>
                                            <a href="{% url 'merchant_detail' user_id=merchant.profile.id %}">
                                                {{ merchant.profile.first_name }}
                                                {{ merchant.profile.last_name }}
                                            </a>
                                        </td>
                                        <td>
                                            {{ merchant.contact.contact_number }}
                                        </td>
                                        <td>
                                            {{ merchant.cube.next_due_date|date:'Y-m-d' }}
                                        </td>
                                        <td>
                                            <a href="{% url 'cube_detail' cube_id=merchant.cube.id %}">
                                                {{ merchant.cube.unit }}
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor%}
                            </tbody>
                        </table>
                    </div>
                    <div class="tab-pane" id="payouts">
                        <table id="payout_table" class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Reference No.</th>
                                    <th>Merchant</th>
                                    <th>Date</th>
                                    <th>Bank</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payout in payouts %}
                                    <tr>
                                        <td>
                                            <a href="{% url 'payout_detail' payout_id=payout.id %}">
                                                {{ payout.reference_number }}
                                            </a>
                                        </td>
                                        <td>
                                            {% if payout.merchant %}
                                                <a href="{% url 'merchant_detail' user_id=payout.merchant.id %}">
                                                    {{ payout.merchant.first_name }} {{ payout.merchant.last_name }}
                                                </a>
                                            {% else %}
                                                <em>None</em>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {{ payout.date|date:'Y-m-d' }}
                                        </td>
                                        <td>
                                            {% if payout.bank %}
                                                ({{ payout.bank.bank }}) {{ payout.bank.account }}
                                            {% else %}
                                                <em>None</em>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {{ payout.amount }}
                                        </td>
                                    </tr>
                                {% endfor%}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>
    <!-- end Main row -->

<div class="modal fade" tabindex="-1" role="dialog" id="dialog-confirm">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">Confirm Purchase</h4>
            </div>
            <div class="modal-body">
                <ul class="list-group list-group-unbordered">
                    <li class="list-group-item">
                        <b>Item</b> <a class="pull-right" id="target-item-code"></a>
                    </li>
                    <li class="list-group-item">
                        <b>Price</b> <a class="pull-right" id="target-item-price"></a>
                    </li>
                    <li class="list-group-item">
                        <b>Quantity</b> <a class="pull-right" id="target-item-quantity"></a>
                    </li>
                    <li class="list-group-item">
                        <b>Discount</b> <a class="pull-right" id="target-item-discount"></a>
                    </li>
                    <li class="list-group-item">
                        <b>Final Price</b> <a class="pull-right" id="target-item-final_price"></a>
                    </li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-block" id="confirm_btn">Submit</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block pagescripts %}
<script src="{% static "bower_components/datatables.net/js/jquery.dataTables.min.js" %}"></script>
<script src="{% static "bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js" %}"></script>
<script>
    $(function () {
        var target_form = null;
        $('.buy_btn').on('click', function (event) {
            target_form = this.form;

            $('#target-item-code').text(target_form.code.value);
            $('#target-item-price').text('Php ' + target_form.price.value);
            $('#target-item-quantity').text(target_form.quantity.value);
            $('#target-item-discount').text(target_form.discount.value + '%');

            var item_price = parseFloat(target_form.price.value);
            var item_discount = parseFloat(target_form.discount.value) * 0.01;
            var item_quantity = parseFloat(target_form.quantity.value);
            var discounted_price_per_item = item_price - (item_price * item_discount);
            var final_price = discounted_price_per_item * item_quantity;

            $('#target-item-final_price').text('Php ' + final_price.toFixed(2));

            event.preventDefault();
            $("#dialog-confirm").modal('show');
        });

        $('#confirm_btn').on('click', function (event) {
            target_form.submit();
            $("#dialog-confirm").modal('hide');
        });


        $('#item_table').DataTable({
            'paging'      : true,
            'lengthChange': false,
            'searching'   : true,
            'info'        : true,
            'autoWidth'   : false,
            'aoColumnDefs' : [{
                               'bSortable' : false,
                               'aTargets' : [ -1 ]
                             }]
        });

        $('#sales_table').DataTable({
            'paging'      : true,
            'lengthChange': false,
            'searching'   : false,
            'ordering'    : true,
            'info'        : true,
            'autoWidth'   : false,
            'order'       : [[1, 'desc']]
        });

        $('#merchants_table').DataTable({
            'paging'      : true,
            'lengthChange': false,
            'searching'   : true,
            'ordering'    : true,
            'info'        : true,
            'autoWidth'   : false,
            'order'       : [[3, 'desc']]
        });

        $('#payout_table').DataTable({
            'paging'      : true,
            'lengthChange': false,
            'searching'   : true,
            'ordering'    : true,
            'info'        : true,
            'autoWidth'   : false,
            'order'       : [[2, 'desc']]
        });
    })
</script>
{% endblock %}